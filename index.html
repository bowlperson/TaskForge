<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TaskForge â€” Gamified Productivity</title>
  <meta name="description" content="Turn your day into an RPG. Create quests, earn XP, and level up Main Stats + Skills." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230ea5e9'/%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' font-size='48' fill='white' font-family='monospace'%3ETF%3C/text%3E%3C/svg%3E" />
  <style>* { scrollbar-width: thin; }</style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <h1 class="text-3xl font-bold">TaskForge <span class="text-sky-400">Beta</span></h1>
      <div class="flex gap-2">
        <button id="btn-export" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Export Save</button>
        <label class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 cursor-pointer">Import Save
          <input id="file-import" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="btn-reset" class="px-3 py-2 rounded-lg bg-rose-700 hover:bg-rose-600">Hard Reset</button>
      </div>
    </header>

    <section class="mt-6 grid md:grid-cols-3 gap-6">
      <!-- Player Card -->
      <div class="md:col-span-1">
        <div class="rounded-2xl bg-slate-900/60 ring-1 ring-white/10 p-4">
          <h2 class="text-xl font-semibold mb-3 flex items-center justify-between">
            <span><span id="player-name-display"></span> <span id="edit-name" class="text-xs cursor-pointer text-sky-400 ml-2">edit</span></span>
            <button id="btn-notify" class="text-xs px-2 py-1 rounded bg-sky-700 hover:bg-sky-600">Enable Notifications</button>
          </h2>
            <div class="space-y-2">
              <div class="flex flex-col items-center mt-2">
                <img id="player-img" src="Commoner.png" alt="Player" class="w-24 h-24 rounded-full object-cover" />
                <div id="player-title" class="mt-2 font-semibold">Commoner</div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div class="rounded bg-slate-800 p-3">
                  <div class="text-3xl font-bold" id="level">1</div>
                  <div class="text-xs opacity-70">Level</div>
                </div>
                <div class="rounded bg-slate-800 p-3">
                  <div class="text-3xl font-bold" id="xp">0</div>
                  <div class="text-xs opacity-70">XP</div>
                </div>
                <div class="rounded bg-slate-800 p-3">
                  <div class="text-3xl font-bold" id="prestige">0</div>
                  <div class="text-xs opacity-70">Prestige</div>
                </div>
                <div class="rounded bg-slate-800 p-3">
                  <div class="text-3xl font-bold" id="gold">0</div>
                  <div class="text-xs opacity-70">Gold</div>
                </div>
              </div>
              <div class="mt-3 text-xs opacity-90">Next level at <span id="next-xp">50</span> XP</div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <button id="btn-open-quests" class="w-full text-left font-semibold hover:text-sky-300">Quests</button>
              <button id="btn-open-stats" class="w-full text-left font-semibold hover:text-sky-300">Main Stats</button>
              <button id="btn-open-skills" class="w-full text-left font-semibold hover:text-sky-300">Skills</button>
              <button id="btn-open-tags" class="w-full text-left font-semibold hover:text-sky-300">Tags</button>
              <button id="btn-open-log" class="w-full text-left font-semibold hover:text-sky-300 col-span-2">Audit Log</button>
            </div>
            </div>
        </div>
      </div>

      <!-- Right Pane Views -->
      <div class="md:col-span-2">
        <div class="rounded-2xl bg-slate-900/60 ring-1 ring-white/10 p-4 min-h-[420px]" id="view-container">
          <!-- Quests View -->
          <div id="view-quests">
            <h2 class="text-xl font-semibold mb-3">Quests</h2>
            <button id="btn-show-form" class="px-4 py-2 mb-3 rounded bg-sky-700 hover:bg-sky-600">Create New Quest</button>
            <form id="quest-form" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-2 items-end">
              <div class="md:col-span-2 sm:col-span-2">
                <label class="text-sm opacity-80">Title</label>
                <input id="q-title" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Gym: Push Day" />
              </div>
              <div>
                <label class="text-sm opacity-80">Difficulty</label>
                <select id="q-diff" class="w-full px-3 py-2 rounded bg-slate-800">
                  <option value="500">Trivial (500 XP)</option>
                  <option value="750">Routine (750 XP)</option>
                  <option value="1000" selected>Standard (1,000 XP)</option>
                  <option value="1500">Challenging (1,500 XP)</option>
                  <option value="2750">Formative (2,750 XP)</option>
                </select>
              </div>
              <div>
                <label class="text-sm opacity-80">Time Completion</label>
                <select id="q-time" class="w-full px-3 py-2 rounded bg-slate-800">
                  <option value="1" selected>None (1x)</option>
                  <option value="0">&lt;1 hr (0x)</option>
                  <option value="1.1">1 hr+ (1.1x)</option>
                  <option value="1.2">4 hrs+ (1.2x)</option>
                  <option value="1.5">12 hrs+ (1.5x)</option>
                  <option value="1.75">24 hrs+ (1.75x)</option>
                  <option value="2.25">Week(s)+ (2.25x)</option>
                  <option value="3.5">Month(s)+ (3.5x)</option>
                </select>
              </div>
              <div>
                <label class="text-sm opacity-80">Skill</label>
                <select id="q-skill" class="w-full px-3 py-2 rounded bg-slate-800"></select>
              </div>
              <div>
                <label class="text-sm opacity-80">Main Stat</label>
                <select id="q-stat" class="w-full px-3 py-2 rounded bg-slate-800"></select>
              </div>
              <div>
                <label class="text-sm opacity-80">Tag</label>
                <select id="q-tag" class="w-full px-3 py-2 rounded bg-slate-800"></select>
              </div>
              <div>
                <label class="text-sm opacity-80">Due</label>
                <input id="q-due" type="datetime-local" class="w-full px-3 py-2 rounded bg-slate-800" />
              </div>
              <div class="sm:col-span-2 md:col-span-7 flex items-center gap-4">
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="q-repeat" class="rounded"> Repeatable</label>
                <span id="q-anti" class="text-sm cursor-pointer text-rose-400">Anti Quest</span>
              </div>
              <div class="md:col-span-7 sm:col-span-2">
                <label class="text-sm opacity-80">Notes</label>
                <textarea id="q-notes" class="w-full px-3 py-2 rounded bg-slate-800" rows="2"></textarea>
              </div>
              <div class="md:col-span-7 sm:col-span-2 flex gap-2">
                <button id="btn-submit-quest" class="px-4 py-2 rounded bg-emerald-700 hover:bg-emerald-600">Add Quest</button>
                <button type="button" id="btn-clear-done" class="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700">Clear Completed</button>
              </div>
            </form>
            <div id="quest-list" class="mt-4 grid gap-3"></div>
          </div>

          <div id="view-stats" class="hidden"><h2 class="text-xl font-semibold mb-3">Main Stats</h2><div id="stats-list"></div></div>
          <div id="view-skills" class="hidden">
            <h2 class="text-xl font-semibold mb-3 flex items-center justify-between">Skills <button id="btn-add-skill" class="text-xs px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600">Add Skill</button></h2>
            <div id="skills-list"></div>
          </div>
          <div id="view-tags" class="hidden">
            <h2 class="text-xl font-semibold mb-3">Tags</h2>
            <div class="flex gap-2 mb-4">
              <input id="tag-name" class="flex-1 px-3 py-2 rounded bg-slate-800" placeholder="Tag name" />
              <input id="tag-color" type="color" value="#0ea5e9" class="w-14 h-10 p-0 border-0 rounded bg-slate-800" />
              <button id="btn-add-tag" class="px-3 py-2 rounded bg-emerald-700 hover:bg-emerald-600">+</button>
            </div>
            <div id="tags-list"></div>
          </div>
          <div id="view-log" class="hidden"><h2 class="text-xl font-semibold mb-3">Audit Log</h2><div id="log-list"></div></div>
        </div>
      </div>
    </section>
  </div>

  <template id="tpl-quest">
    <div class="rounded-xl bg-slate-800 p-3 ring-1 ring-white/10 q-card">
      <h3 class="q-title font-semibold"></h3>
      <div class="mt-1 text-xs flex items-center gap-1">
        <span class="px-2 py-0.5 rounded bg-sky-700/50"><span class="q-xp"></span> XP</span>
        <span class="px-2 py-0.5 rounded bg-fuchsia-700/40 q-tag-stat"></span>
        <span class="px-2 py-0.5 rounded bg-amber-700/40 q-tag-skill hidden"></span>
        <span class="q-tag hidden px-2 py-0.5 rounded text-slate-900"></span>
      </div>
      <div class="q-due text-xs opacity-70 mt-1"></div>
      <p class="q-notes text-sm opacity-85 mt-2"></p>
      <div class="mt-3 flex gap-2">
        <button class="q-complete flex-1 px-3 py-2 rounded bg-emerald-700 hover:bg-emerald-600 text-sm">Completed</button>
        <button class="q-edit px-3 py-2 rounded bg-sky-700 hover:bg-sky-600 text-sm">Edit</button>
        <button class="q-delete px-3 py-2 rounded bg-rose-700 hover:bg-rose-600 text-sm">Delete</button>
      </div>
    </div>
  </template>

  <template id="tpl-log">
    <div class="rounded-xl bg-slate-800 p-3 ring-1 ring-white/10">
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1">
          <h3 class="l-title font-semibold"></h3>
          <div class="text-xs opacity-70 mt-1"><span class="l-xp"></span> XP <span class="l-stat"></span> <span class="l-skill"></span> <span class="l-due"></span></div>
          <p class="l-notes text-sm opacity-85 mt-1"></p>
        </div>
        <button class="l-undo text-xs px-2 py-1 rounded bg-rose-700 hover:bg-rose-600">Undo</button>
      </div>
    </div>
  </template>

  <div id="modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center">
    <div id="modal-box" class="bg-slate-900 p-4 rounded-lg max-w-sm w-full"></div>
  </div>

<script>
const DEFAULT_SAVE = {
  player: {
    name: "Bowl",
    level: 1,
    xp: 0,
    prestige: 0,
    gold: 0,
    mainstats: {
      Strength: 0,
      Dexterity: 0,
      Constitution: 0,
      Intelligence: 0,
      Wisdom: 0,
      Charisma: 0
    },
    skills: {}
  },
  quests: [],
  log: [],
  tags: []
};
const el = id => document.getElementById(id);
const state =
  JSON.parse(localStorage.getItem("taskforge_save") || "null") ||
  structuredClone(DEFAULT_SAVE);
if (!state.tags) state.tags = [];
if (!state.player.skills) state.player.skills = {};
if (state.player.prestige === undefined) state.player.prestige = 0;
if (state.player.gold === undefined) state.player.gold = 0;
let statsChart = null;
let editingId = null;
let antiQuest = false;
const goldSound = new Audio("Sound Effects/goldcoins.mp3");
const levelSounds = [
  new Audio("Sound Effects/lvlupfallout.mp3"),
  new Audio("Sound Effects/lvlupskyrim.mp3")
];
let currentLvlSound = null;

function showModal(content) {
  const box = el("modal-box");
  box.innerHTML = "";
  box.appendChild(content);
  el("modal").classList.remove("hidden");
}

function closeModal() {
  el("modal").classList.add("hidden");
}

function textModal(label, value, cb) {
  const div = document.createElement("div");
  div.innerHTML = `<label class="block mb-2">${label}</label>
    <input id="modal-input" class="w-full px-3 py-2 rounded bg-slate-800 mb-4" value="${value || ""}" />
    <div class="text-right space-x-2">
      <button id="modal-cancel" class="px-3 py-1 rounded bg-slate-700">Cancel</button>
      <button id="modal-ok" class="px-3 py-1 rounded bg-emerald-700">Save</button>
    </div>`;
  showModal(div);
  el("modal-ok").onclick = () => {
    const val = el("modal-input").value.trim();
    closeModal();
    cb(val);
  };
  el("modal-cancel").onclick = closeModal;
}

function tagModal(tag, cb) {
  const div = document.createElement("div");
  div.innerHTML = `<label class="block mb-2">Tag name</label>
    <input id="modal-tag-name" class="w-full px-3 py-2 rounded bg-slate-800 mb-2" value="${tag.name}" />
    <label class="block mb-2">Color</label>
    <input id="modal-tag-color" type="color" class="w-full h-10 p-0 rounded bg-slate-800 mb-4" value="${tag.color}" />
    <div class="text-right space-x-2">
      <button id="modal-cancel" class="px-3 py-1 rounded bg-slate-700">Cancel</button>
      <button id="modal-ok" class="px-3 py-1 rounded bg-emerald-700">Save</button>
    </div>`;
  showModal(div);
  el("modal-ok").onclick = () => {
    cb(el("modal-tag-name").value.trim(), el("modal-tag-color").value);
    closeModal();
  };
  el("modal-cancel").onclick = closeModal;
}

function confirmModal(html, cb) {
  const div = document.createElement("div");
  div.innerHTML = `<div class="mb-4 text-sm">${html}</div>
    <div class="text-right space-x-2">
      <button id="modal-cancel" class="px-3 py-1 rounded bg-slate-700">Cancel</button>
      <button id="modal-ok" class="px-3 py-1 rounded bg-emerald-700">Confirm</button>
    </div>`;
  showModal(div);
  el("modal-ok").onclick = () => {
    closeModal();
    cb();
  };
  el("modal-cancel").onclick = closeModal;
}

function infoModal(html) {
  const div = document.createElement("div");
  div.innerHTML = `<div class="mb-4 text-sm">${html}</div>
    <div class="text-right">
      <button id="modal-ok" class="px-3 py-1 rounded bg-emerald-700">OK</button>
    </div>`;
  showModal(div);
  el("modal-ok").onclick = closeModal;
}
const TITLE_TIERS = [
  { level: 400, title: "Mortal Savant" },
  { level: 350, title: "FalconKnight" },
  { level: 300, title: "SpellSword" },
  { level: 250, title: "SwordMaster" },
  { level: 200, title: "Paladin" },
  { level: 150, title: "Hero" },
  { level: 125, title: "Mercenary" },
  { level: 100, title: "Soilder" },
  { level: 50, title: "Fighter" },
  { level: 25, title: "Adventurer" },
  { level: 1, title: "Commoner" }
];
function getTitle(level) {
  return TITLE_TIERS.find(t => level >= t.level)?.title || "Commoner";
}
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function goldForDiff(diff) {
  if (diff <= 500) return rand(1, 5);
  if (diff <= 750) return rand(5, 30);
  if (diff <= 1000) return rand(25, 60);
  if (diff <= 1500) return rand(70, 100);
  return rand(100, 300);
}
function save() {
  localStorage.setItem("taskforge_save", JSON.stringify(state));
}
function show(view) {
  ["view-quests", "view-stats", "view-skills", "view-tags", "view-log"].forEach(id =>
    el(id).classList.toggle("hidden", id !== view)
  );
}
  function nextLevelXP() {
    const lvl = ((state.player.level - 1) % 100) + 1;
    return lvl * 50;
  }
  function addXP(amount) {
    state.player.xp += amount;
    while (state.player.xp >= nextLevelXP()) {
      state.player.xp -= nextLevelXP();
      state.player.level++;
      if (state.player.level % 100 === 1) {
        state.player.prestige = (state.player.prestige || 0) + 1;
        state.player.xp = 0;
        break;
      }
    }
    while (state.player.xp < 0 && state.player.level > 1) {
      state.player.level--;
      if (state.player.level % 100 === 0 && state.player.prestige) state.player.prestige--;
      state.player.xp += nextLevelXP();
    }
    if (state.player.xp < 0) state.player.xp = 0;
  }
function confirmQuest(id) {
  const q = state.quests.find(q => q.id === id);
  if (!q) return;
  const gold = goldForDiff(q.diff);
  const st = q.stat ? Math.floor(Math.abs(q.xp) / 300) : 0;
  const sp = q.skill ? Math.floor(Math.abs(q.xp) / 30) : 0;
  let html = `Claim rewards for <strong>${q.title}</strong>?<br>XP: ${q.xp >= 0 ? "+" + q.xp : q.xp}<br>Gold: ${gold}`;
  if (q.stat) html += `<br>${q.stat} ${q.xp < 0 ? "-" : "+"}${st}`;
  if (q.skill) html += `<br>${q.skill} ${q.xp < 0 ? "-" : "+"}${sp}`;
  confirmModal(html, () => completeQuest(id, gold, st, sp));
}
function completeQuest(id, gold, st, sp) {
  const idx = state.quests.findIndex(q => q.id === id);
  if (idx === -1) return;
  const q = state.quests[idx];
  if (currentLvlSound) {
    currentLvlSound.pause();
    currentLvlSound.currentTime = 0;
    currentLvlSound = null;
  }
  const levelBefore = state.player.level;
  addXP(q.xp);
  let statPoints = 0;
  if (q.stat) {
    statPoints = q.xp < 0 ? -st : st;
    state.player.mainstats[q.stat] = Math.max(
      0,
      (state.player.mainstats[q.stat] || 0) + statPoints
    );
  }
  let skillPoints = 0;
  if (q.skill) {
    skillPoints = q.xp < 0 ? -sp : sp;
    state.player.skills[q.skill] = Math.max(
      0,
      (state.player.skills[q.skill] || 0) + skillPoints
    );
    if (state.player.skills[q.skill] === 0) delete state.player.skills[q.skill];
  }
  state.player.gold += gold;
  const logEntry = {
    id: crypto.randomUUID(),
    questId: q.id,
    title: q.title,
    xp: q.xp,
    diff: q.diff,
    time: q.time,
    stat: q.stat,
    skill: q.skill,
    tag: q.tag,
    notes: q.notes,
    repeat: q.repeat,
    anti: q.anti,
    due: q.due,
    statPoints: statPoints,
    skillPoints: skillPoints,
    gold,
    completedAt: Date.now()
  };
  state.log.push(logEntry);
  if (state.log.length > 200) state.log.shift();
  if (!q.repeat) state.quests.splice(idx, 1);
  save();
  render();
  const levelAfter = state.player.level;
  if (levelAfter > levelBefore) {
    currentLvlSound = levelSounds[Math.floor(Math.random() * levelSounds.length)];
    currentLvlSound.play();
  } else {
    goldSound.play();
  }
  let summary = `${q.xp >= 0 ? "+" + q.xp : q.xp} XP<br>+${gold} Gold`;
  if (q.stat) summary += `<br>${q.stat} ${statPoints > 0 ? "+" : ""}${statPoints}`;
  if (q.skill) summary += `<br>${q.skill} ${skillPoints > 0 ? "+" : ""}${skillPoints}`;
  infoModal(summary);
}
function deleteQuest(id) {
  const idx = state.quests.findIndex(q => q.id === id);
  if (idx === -1) return;
  state.quests.splice(idx, 1);
  save();
  render();
}
function editTag(id) {
  const t = state.tags.find(t => t.id === id);
  if (!t) return;
  tagModal(t, (name, color) => {
    if (name) {
      t.name = name;
      t.color = color;
      save();
      render();
    }
  });
}
function deleteTag(id) {
  const idx = state.tags.findIndex(t => t.id === id);
  if (idx === -1) return;
  state.tags.splice(idx, 1);
  state.quests.forEach(q => {
    if (q.tag === id) q.tag = "";
  });
  save();
  render();
}
function editSkill(name) {
  const val = state.player.skills[name];
  textModal("Rename skill", name, newName => {
    if (newName && !state.player.skills[newName]) {
      state.player.skills[newName] = val;
      delete state.player.skills[name];
      save();
      render();
    }
  });
}
function deleteSkill(name) {
  delete state.player.skills[name];
  save();
  render();
}
function undoQuest(logId) {
  const idx = state.log.findIndex(l => l.id === logId);
  if (idx === -1) return;
  const l = state.log[idx];
  addXP(-l.xp);
  state.player.gold = Math.max(0, state.player.gold - (l.gold || 0));
  if (l.stat) {
    state.player.mainstats[l.stat] = Math.max(
      0,
      (state.player.mainstats[l.stat] || 0) - l.statPoints
    );
  }
  if (l.skill) {
    state.player.skills[l.skill] = Math.max(
      0,
      (state.player.skills[l.skill] || 0) - l.skillPoints
    );
    if (state.player.skills[l.skill] === 0) delete state.player.skills[l.skill];
  }
  state.log.splice(idx, 1);
  if (!l.repeat) {
    state.quests.push({
      id: l.questId,
      title: l.title,
      diff: l.diff,
      time: l.time,
      xp: l.xp,
      stat: l.stat,
      skill: l.skill,
      tag: l.tag,
      notes: l.notes,
      repeat: l.repeat,
      anti: l.anti,
      due: l.due
    });
  }
  save();
  render();
}
function startEdit(id) {
  const q = state.quests.find(q => q.id === id);
  if (!q) return;
  editingId = id;
  antiQuest = q.anti || false;
  el("quest-form").classList.remove("hidden");
  el("q-title").value = q.title;
  el("q-diff").value = q.diff || 1000;
  el("q-time").value = q.time || 1;
  el("q-skill").value = q.skill || "";
  el("q-stat").value = q.stat || "";
  el("q-tag").value = q.tag || "";
  el("q-due").value = q.due || "";
  el("q-repeat").checked = q.repeat || false;
  el("q-notes").value = q.notes || "";
  el("q-anti").classList.toggle("font-bold", antiQuest);
}
  function render() {
    el("player-name-display").textContent = state.player.name;
    el("level").textContent = state.player.level;
    el("xp").textContent = state.player.xp;
    el("prestige").textContent = state.player.prestige;
    el("gold").textContent = state.player.gold;
    const title = getTitle(state.player.level);
    el("player-title").textContent = title;
    el("player-img").src = `${title}.png`; // ensure png name matches title exactly
    el("next-xp").textContent = nextLevelXP();
    el("q-stat").innerHTML =
      '<option value="">None</option>' +
      Object.keys(state.player.mainstats)
        .map(n => `<option value="${n}">${n}</option>`)
        .join("");
  el("q-skill").innerHTML =
    '<option value="">None</option>' +
    Object.keys(state.player.skills)
      .map(n => `<option value="${n}">${n}</option>`)
      .join("");
  el("q-tag").innerHTML =
    '<option value="">None</option>' +
    state.tags.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
  const qlist = el("quest-list");
  qlist.innerHTML = "";
  if (state.quests.length === 0) {
    qlist.innerHTML = '<div class="text-sm opacity-70">No quests yet.</div>';
  } else {
    state.quests.forEach(q => {
      const node = el("tpl-quest").content.cloneNode(true);
      node.querySelector(".q-title").textContent = q.title;
      node.querySelector(".q-xp").textContent = q.xp >= 0 ? `+${q.xp}` : q.xp;
      node.querySelector(".q-tag-stat").textContent = q.stat;
      if (q.skill) {
        const s = node.querySelector(".q-tag-skill");
        s.textContent = q.skill;
        s.classList.remove("hidden");
      }
      if (q.tag) {
        const t = state.tags.find(t => t.id === q.tag);
        if (t) {
          const tg = node.querySelector(".q-tag");
          tg.textContent = t.name;
          tg.style.backgroundColor = t.color;
          tg.classList.remove("hidden");
        }
      }
      if (q.anti) {
        node.querySelector(".q-card").classList.add("bg-rose-900");
      }
      if (q.due) {
        const d = new Date(q.due);
        node.querySelector(".q-due").textContent = `Due: ${d.toLocaleString()}`;
      } else {
        node.querySelector(".q-due").classList.add("hidden");
      }
      node.querySelector(".q-complete").onclick = () => confirmQuest(q.id);
      node.querySelector(".q-delete").onclick = () => deleteQuest(q.id);
      node.querySelector(".q-edit").onclick = () => startEdit(q.id);
      node.querySelector(".q-notes").textContent = q.notes;
      qlist.appendChild(node);
    });
  }
  const statsList = el("stats-list");
  statsList.innerHTML =
    '<canvas id="stats-chart"></canvas><table id="stats-table" class="mt-4 w-full text-sm"></table>';
  const ctx = el("stats-chart");
  if (statsChart) statsChart.destroy();
  statsChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: Object.keys(state.player.mainstats),
      datasets: [
        {
          data: Object.values(state.player.mainstats),
          backgroundColor: "rgba(14,165,233,0.2)",
          borderColor: "#0ea5e9"
        }
      ]
    },
    options: {
      scales: {
        r: {
          beginAtZero: true,
          ticks: { display: false },
          grid: { color: 'rgba(255,255,255,0.1)' },
          angleLines: { color: 'rgba(255,255,255,0.1)' },
          pointLabels: { color: '#cbd5e1' }
        }
      },
      plugins: { legend: { display: false } }
    }
  });
  const statsTable = el("stats-table");
  statsTable.innerHTML = Object.entries(state.player.mainstats)
    .map(([n, v]) => `<tr><td class="py-1">${n}</td><td class="py-1 text-right">${v}</td></tr>`)
    .join("");
  const skillsList = el("skills-list");
  skillsList.innerHTML = "";
  const sk = state.player.skills;
  if (Object.keys(sk).length === 0) {
    skillsList.innerHTML = '<div class="text-sm opacity-70">No skills yet.</div>';
  } else {
    Object.entries(sk).forEach(([n, v]) => {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 mb-1 text-sm";
      div.innerHTML = `<span class=\"flex-1\">${n}: ${v}</span><span class=\"cursor-pointer text-sky-400\" data-act=\"edit\">edit</span><span class=\"cursor-pointer text-rose-400\" data-act=\"del\">delete</span>`;
      div.querySelector('[data-act="edit"]').onclick = () => editSkill(n);
      div.querySelector('[data-act="del"]').onclick = () => deleteSkill(n);
      skillsList.appendChild(div);
    });
  }
  const tagsList = el("tags-list");
  tagsList.innerHTML = "";
  if (state.tags.length === 0) {
    tagsList.innerHTML = '<div class="text-sm opacity-70">No tags yet.</div>';
  } else {
    state.tags.forEach(t => {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 mb-1 text-sm";
      div.innerHTML = `<span class=\"w-4 h-4 rounded\" style=\"background:${t.color}\"></span><span class=\"flex-1\">${t.name}</span><span class=\"cursor-pointer text-sky-400\" data-act=\"edit\">edit</span><span class=\"cursor-pointer text-rose-400\" data-act=\"del\">delete</span>`;
      div.querySelector('[data-act="edit"]').onclick = () => editTag(t.id);
      div.querySelector('[data-act="del"]').onclick = () => deleteTag(t.id);
      tagsList.appendChild(div);
    });
  }
  const logList = el("log-list");
  logList.innerHTML = "";
  if (state.log.length === 0) {
    logList.innerHTML = '<div class="text-sm opacity-70">No completed quests yet.</div>';
  } else {
    state.log
      .slice()
      .reverse()
      .forEach(l => {
        const node = el("tpl-log").content.cloneNode(true);
        node.querySelector(".l-title").textContent = l.title;
        node.querySelector(".l-xp").textContent = l.xp >= 0 ? `+${l.xp}` : l.xp;
        node.querySelector(".l-stat").textContent = l.stat || "";
        node.querySelector(".l-skill").textContent = l.skill
          ? `(${l.skill}+${l.skillPoints})`
          : "";
        if (l.due) node.querySelector(".l-due").textContent = `Due: ${new Date(l.due).toLocaleString()}`;
        node.querySelector(".l-notes").textContent = l.notes;
        node.querySelector(".l-undo").onclick = () => undoQuest(l.id);
        logList.appendChild(node);
      });
  }
  el("btn-submit-quest").textContent = editingId ? "Save Changes" : "Add Quest";
}
// Events
el("edit-name").onclick = () => {
  textModal("Player name", state.player.name, val => {
    if (val) {
      state.player.name = val;
      save();
      render();
    }
  });
};
el("btn-open-quests").onclick = () => show("view-quests");
el("btn-open-stats").onclick = () => show("view-stats");
el("btn-open-skills").onclick = () => show("view-skills");
el("btn-open-tags").onclick = () => show("view-tags");
el("btn-open-log").onclick = () => show("view-log");
el("btn-show-form").onclick = () => {
  editingId = null;
  antiQuest = false;
  el("q-anti").classList.remove("font-bold");
  el("quest-form").reset();
  el("quest-form").classList.toggle("hidden");
};
el("quest-form").onsubmit = e => {
  e.preventDefault();
  const diff = +el("q-diff").value;
  const time = +el("q-time").value;
  const baseXP = Math.round(diff * time);
  const xp = antiQuest ? Math.round(baseXP * -0.25) : baseXP;
  const q = {
    id: editingId || crypto.randomUUID(),
    title: el("q-title").value || "Untitled",
    diff,
    time,
    xp,
    stat: el("q-stat").value,
    skill: el("q-skill").value || "",
    tag: el("q-tag").value || "",
    due: el("q-due").value || "",
    repeat: el("q-repeat").checked,
    anti: antiQuest,
    notes: el("q-notes").value
  };
  const existing = state.quests.findIndex(q => q.id === editingId);
  if (existing !== -1) state.quests[existing] = q; else state.quests.push(q);
  editingId = null;
  antiQuest = false;
  save();
  render();
  el("quest-form").reset();
  el("quest-form").classList.add("hidden");
};
el("btn-clear-done").onclick = () => {
  state.quests = [];
  save();
  render();
};
el("btn-reset").onclick = () => {
  const div = document.createElement("div");
  div.innerHTML = `<div class=\"mb-2 text-sm\">Type your player name (${state.player.name}) to confirm reset</div>
    <input id=\"modal-input\" class=\"w-full px-3 py-2 rounded bg-slate-800 mb-4\" />
    <div class=\"text-right space-x-2\">
      <button id=\"modal-cancel\" class=\"px-3 py-1 rounded bg-slate-700\">Cancel</button>
      <button id=\"modal-ok\" class=\"px-3 py-1 rounded bg-rose-700\">Reset</button>
    </div>`;
  showModal(div);
  el("modal-ok").onclick = () => {
    if (el("modal-input").value === state.player.name) {
      localStorage.removeItem("taskforge_save");
      location.reload();
    }
    closeModal();
  };
  el("modal-cancel").onclick = closeModal;
};
el("btn-add-skill").onclick = () => {
  textModal("Skill name?", "", name => {
    if (name && !state.player.skills[name]) {
      state.player.skills[name] = 0;
      save();
      render();
    }
  });
};
el("btn-add-tag").onclick = () => {
  const name = el("tag-name").value.trim();
  const color = el("tag-color").value;
  if (name) {
    state.tags.push({ id: crypto.randomUUID(), name, color });
    el("tag-name").value = "";
    save();
    render();
  }
};
el("q-anti").onclick = () => {
  antiQuest = !antiQuest;
  el("q-anti").classList.toggle("font-bold", antiQuest);
};
render();
</script>
</body>
</html>
